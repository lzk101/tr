import numpy as np
import matplotlib.pyplot as plt
from matplotlib.patches import Circle
from mpl_toolkits.mplot3d import Axes3D
import mpl_toolkits.mplot3d.art3d as art3d
import os
from datetime import datetime
from matplotlib.lines import Line2D

# 配置字体（优先使用 DejaVu Sans 以支持广泛字符）
plt.rcParams['font.sans-serif'] = ['DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

# 创建输出目录
output_dir = "battlefield_images"
if not os.path.exists(output_dir):
    os.makedirs(output_dir)

# 生成文件名时间戳
timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")

# 创建包含两个子图的图形
fig = plt.figure(figsize=(16, 8))

# 第一个子图：全景视图
ax1 = fig.add_subplot(121, projection='3d')

# 定义坐标数据
fake_target = np.array([0, 0, 0])
real_target = np.array([0, 200, 0])

missiles = {
    'M1': np.array([20000, 0, 2000]),
    'M2': np.array([19000, 600, 2100]),
    'M3': np.array([18000, -600, 1900])
}

drones = {
    'FY1': np.array([17800, 0, 1800]),
    'FY2': np.array([12000, 1400, 1400]),
    'FY3': np.array([6000, -3000, 700]),
    'FY4': np.array([11000, 2000, 1800]),
    'FY5': np.array([13000, -2000, 1300])
}

# 绘制圆柱体
def draw_cylinder(ax, center, radius, height, color, alpha=0.6):
    circle_bottom = Circle((center[0], center[1]), radius, color=color, alpha=alpha)
    ax.add_patch(circle_bottom)
    art3d.pathpatch_2d_to_3d(circle_bottom, z=center[2], zdir="z")
    
    circle_top = Circle((center[0], center[1]), radius, color=color, alpha=alpha)
    ax.add_patch(circle_top)
    art3d.pathpatch_2d_to_3d(circle_top, z=center[2] + height, zdir="z")
    
    return circle_bottom

# 绘制诱饵目标（红色圆柱）——以高度区分
fake_cylinder = draw_cylinder(ax1, fake_target, 10, 15, 'red', 0.9)
ax1.text(fake_target[0], fake_target[1], fake_target[2] + 20, '诱饵目标', 
    color='red', fontsize=14, ha='center', fontweight='bold', 
    bbox=dict(boxstyle="round,pad=0.3", facecolor="white", alpha=0.8))

# 绘制真实目标（蓝色圆柱）——以高度区分
real_cylinder = draw_cylinder(ax1, real_target, 10, 20, 'blue', 0.9)
ax1.text(real_target[0], real_target[1], real_target[2] + 25, '真实目标', 
    color='blue', fontsize=14, ha='center', fontweight='bold',
    bbox=dict(boxstyle="round,pad=0.3", facecolor="white", alpha=0.8))

# 绘制导弹（红色三角）
for name, pos in missiles.items():
    ax1.scatter(pos[0], pos[1], pos[2], c='red', marker='^', s=300,
               edgecolors='black', linewidth=2)
    # 调整标签位置，使其靠近标记
    label_offset = 500
    ax1.text(pos[0] + label_offset, pos[1] + label_offset, pos[2] + label_offset, name, 
            color='red', fontsize=13, fontweight='bold',
            bbox=dict(boxstyle="round,pad=0.2", facecolor="white", alpha=0.7))

# 绘制无人机（绿色正方形）
for name, pos in drones.items():
    ax1.scatter(pos[0], pos[1], pos[2], c='green', marker='s', s=200,
               edgecolors='black', linewidth=1.5)
    # 调整标签位置，使其靠近标记
    label_offset = 500
    ax1.text(pos[0] + label_offset, pos[1] + label_offset, pos[2] + label_offset, name, 
            color='green', fontsize=12, fontweight='bold',
            bbox=dict(boxstyle="round,pad=0.2", facecolor="white", alpha=0.7))

# 绘制导弹飞行方向箭头
for name, pos in missiles.items():
    direction = fake_target - pos
    direction_norm = direction / np.linalg.norm(direction)
    arrow_length = 1000
    
    ax1.quiver(pos[0], pos[1], pos[2], 
              direction_norm[0] * arrow_length,
              direction_norm[1] * arrow_length,
              direction_norm[2] * arrow_length,
              color='orange', arrow_length_ratio=0.25,
              linewidth=3, alpha=0.9)

# 调整 ax1 视角并添加简短说明
ax1.view_init(elev=20, azim=-60)
ax1.text2D(0.02, 0.95, 
          "情景:\n"
          "• 红色圆柱: 诱饵目标\n"
          "• 蓝色圆柱: 真实目标\n"
          "• 红色三角: 导弹\n"
          "• 绿色正方: 无人机\n"
          "• 橙色箭头: 飞行方向", 
          transform=ax1.transAxes, fontsize=10, verticalalignment='top',
          bbox=dict(boxstyle="round,pad=0.4", facecolor="lightyellow", 
                   alpha=0.8, edgecolor='gold'))

# 第二个子图：目标区域放大
ax2 = fig.add_subplot(122, projection='3d')

# Draw target area close-up
draw_cylinder(ax2, fake_target, 10, 15, 'red', 0.9)
draw_cylinder(ax2, real_target, 10, 20, 'blue', 0.9)

ax2.text(fake_target[0], fake_target[1], fake_target[2] + 18, '诱饵目标', 
         color='red', fontsize=14, ha='center', fontweight='bold',
         bbox=dict(boxstyle="round,pad=0.3", facecolor="white", alpha=0.8))
ax2.text(real_target[0], real_target[1], real_target[2] + 23, '真实目标', 
         color='blue', fontsize=14, ha='center', fontweight='bold',
         bbox=dict(boxstyle="round,pad=0.3", facecolor="white", alpha=0.8))

# Set unequal axis ranges for the close-up view
ax2.set_xlim([-50, 250])
ax2.set_ylim([-50, 250])
ax2.set_zlim([-10, 60])

ax2.set_xlabel('X 坐标 (m)', fontsize=12, fontweight='bold')
ax2.set_ylabel('Y 坐标 (m)', fontsize=12, fontweight='bold')
ax2.set_zlabel('Z 坐标 (m)', fontsize=12, fontweight='bold')
ax2.set_title('目标区域放大\n（诱饵与真实目标高度差）', fontsize=14, fontweight='bold')

ax2.grid(True, alpha=0.4)
ax2.view_init(elev=35, azim=-45)

# Add distance annotation
ax2.plot([0, 0], [0, 200], [15, 20], 'k--', alpha=0.6)
ax2.text(10, 100, 18, '200米', fontsize=11, fontweight='bold',
    bbox=dict(boxstyle="round,pad=0.2", facecolor="white", alpha=0.7))

plt.tight_layout()

# Save images
save_path_png = os.path.join(output_dir, f"battlefield_3d_map_{timestamp}.png")
save_path_pdf = os.path.join(output_dir, f"battlefield_3d_map_{timestamp}.pdf")

plt.savefig(save_path_png, dpi=300, bbox_inches='tight', facecolor='white')
plt.savefig(save_path_pdf, bbox_inches='tight', facecolor='white')

print(f"图片已保存到目录: {output_dir}")
print(f"PNG 文件: battlefield_3d_map_{timestamp}.png")
print(f"PDF 文件: battlefield_3d_map_{timestamp}.pdf")

# Show (may be non-interactive in headless backends)
plt.show()

# Save info
print(f"\n文件已保存！")
print(f"生成的图片位于文件夹 '{output_dir}'")
